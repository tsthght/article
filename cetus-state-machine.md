### Cetus的SQL处理状态机
#### 1 概述
Cetus是北京网易乐得DBA团队和SA团队联合打造的一款MySQL数据库中间件。Cetus具有读写分离版本和分库版本，已经部署在网易乐得部门众多线上MySQL集群，性能和稳定性均表现良好。其开源地址为:https://github.com/Lede-Inc/cetus，欢迎star关注。

本文主要对Cetus的SQL处理状态机进行介绍。

目前Cetus中间件对外提供两个端口：管理（admin）端口和代理（proxy）端口。管理端口用来对Cetus进行管理、监控，通过管理端口提供的API，用户可以修改Cetus的参数配置、查看状态监控等；代理端口用于提供对MySQL的透明化代理服务，用户连接代理端口可以正常的进行MySQL的各种操作。

无论是管理端口还是代理端口，Cetus都要接收用户发送过来的SQL，并将处理结果返回给用户。在处理SQL的过程中，使用了异步事件模式，因此需要对当前SQL处理的状态进行记录，并且根据SQL处理的不同阶段，进行相应的状态迁移。每一条SQL的处理的各阶段状态序列，其实便是状态机的迁移来表达的。接下来将会简单的分析Cetus的管理端口和代理端口的状态机。

#### 2 状态机入口

在介绍Cetus的SQL处理状态机之前，首先介绍一下每条SQL是如何进入状态机执行的。

Cetus中间件作为服务程序，会暴露给客户端相应的端口，即管理端口和代理端口，端口是通过配置文件中的`admin-address`和`proxy-address`参数分别配置的。Cetus会创建套接字(socket)来监听对应的端口，并且会对各个监听端口上的套接字描述文件注册事件回调函数，该函数便引导SQL进入状态机执行。

在Cetus中，注册的回调函数为`network_mysqld_con_accept`，该函数中主要完成套接字的accept功能，获取客户端连接的相关属性信息。在该函数中，会调用`network_mysqld_con_handle`函数，真正进入状态机，对SQL进行处理。

状态机内部，是通过状态的迁移而进行推进的，即每完成相应的操作，状态便进行迁移。虽然管理端口状态机和代理端口状态机有所不同，但是其入口均是`network_mysqld_con_handle`，下面将详细进行叙述状态机。

![3.2.1](./images/3.2.1.png)

#### 3 管理端口状态机



![3.3.1](./images/3.3.1.png)

#### 4 代理端口状态机



